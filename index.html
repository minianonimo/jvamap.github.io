<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rastreador GPS com Frequência de Visitas</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: #0d1117;
      color: #fff;
    }
    h1 {
      background: #010409;
      color: #58a6ff;
      padding: 12px 12px 12px 60px;
      text-align: center;
      font-size: 1.6rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.5);
      position: relative;
    }
    #logo {
      position: absolute;
      top: 10px;
      left: 10px;
      height: 70px;
      border-radius: 50%;
      box-shadow: 0 0 10px #00f0ff;
    }
    #status {
      background: #161b22;
      padding: 10px;
      text-align: center;
      font-size: 0.95rem;
      color: #c9d1d9;
    }
    #controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(33,38,45,0.9);
      padding: 10px;
      border-radius: 8px;
      z-index: 999;
    }
    #controls label, #controls select {
      color: #58a6ff;
      font-size: 1rem;
    }
    #map {
      flex: 1;
      width: 100%;
      background: #000;
    }
  </style>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>
<body>
  <h1>
    <img id="logo" src="img/neurotag.jpg" alt="Logo do Projeto" />
    Rastreador GPS 
  </h1>
  <div id="status">Autenticando...</div>
  <div id="controls">
    <label for="datas">Histórico por Data:</label>
    <select id="datas"><option value="">Selecione</option></select>
  </div>
  <div id="map"></div>

  <script>
    /* ==========================
       CONFIGURAÇÃO LOCAL
       ========================== */
    // Coordenadas aproximadas de Manhumirim-MG (ajuste se desejar o ponto EXATO da escola)
    const BASE_LAT = -20.3590;
    const BASE_LNG = -41.9580;

    // UID que você já usa
    const uid = "usuario1";

    /* ==========================
       FIREBASE
       ========================== */
    const firebaseConfig = {
      apiKey: "AIzaSyB8aZCcS5FKDYrbDjRTbk_NLH1s55IUOUU",
      authDomain: "rastreador-gps-2550c.firebaseapp.com",
      databaseURL: "https://rastreador-gps-2550c-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);

    const email = "ds4224625@gmail.com";
    const senha = "barata234";

    const statusEl = document.getElementById("status");
    const selectDatas = document.getElementById("datas");

    let map, marker, linhas = [], heatMap = {};

    firebase.auth().signInWithEmailAndPassword(email, senha)
      .then(async () => {
        statusEl.textContent = "Autenticado com sucesso!";
        await seedHistoricoIfEmpty();      // <<<<<< cria histórico simulado (últimos 30 dias)
        iniciarMapa();                     // inicia mapa “ao vivo” (hoje)
        preencherHistorico();              // preenche select com datas
        setInterval(limparDadosAntigos, 5 * 60 * 1000);
      })
      .catch((error) => {
        statusEl.textContent = "Erro ao autenticar: " + error.message;
      });

    /* ==========================
       MAPA “AO VIVO” (HOJE)
       ========================== */
    function iniciarMapa() {
      map = L.map('map').setView([BASE_LAT, BASE_LNG], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      marker = L.marker([BASE_LAT, BASE_LNG]).addTo(map);

      const hoje = new Date().toISOString().slice(0, 10);
      const caminho = `/localizacoes/${hoje}/${uid}`;

      firebase.database().ref(caminho).on("value", (snapshot) => {
        const pontos = [];
        heatMap = {}; // reset para o dia atual

        // Ordena por timestamp crescente
        const arr = [];
        snapshot.forEach(child => arr.push({ key: child.key, val: child.val() }));
        arr.sort((a,b) => Number(a.key) - Number(b.key));

        arr.forEach(({val}) => {
          const { latitude, longitude } = val || {};
          if (typeof latitude === "number" && typeof longitude === "number") {
            const key = `${latitude.toFixed(5)},${longitude.toFixed(5)}`;
            heatMap[key] = (heatMap[key] || 0) + 1;
            pontos.push([latitude, longitude]);
          }
        });

        if (pontos.length) {
          const last = pontos[pontos.length - 1];
          marker.setLatLng(last);
          map.panTo(last);
        }

        desenharLinhas(pontos);
      });
    }

    /* ==========================
       DESENHAR RASTRO COM CORES
       ========================== */
    function desenharLinhas(pontos) {
      // limpa linhas antigas
      linhas.forEach(linha => map.removeLayer(linha));
      linhas.length = 0;

      for (let i = 1; i < pontos.length; i++) {
        const p1 = pontos[i - 1];
        const p2 = pontos[i];
        const chave = `${p2[0].toFixed(5)},${p2[1].toFixed(5)}`;
        const freq = heatMap[chave] || 1;
        // vermelho = 1a vez; amarelo = >=3; azul = >=4/semana (aqui usamos freq aproximado no dia)
        let cor = "red";
        if (freq >= 4) cor = "blue";
        else if (freq >= 3) cor = "yellow";

        const linha = L.polyline([p1, p2], { color: cor, weight: 4 }).addTo(map);
        linhas.push(linha);
      }
    }

    /* ==========================
       HISTÓRICO (SELECT)
       ========================== */
    function preencherHistorico() {
      firebase.database().ref("/localizacoes").once("value", (snap) => {
        const datas = Object.keys(snap.val() || {}).sort().reverse();
        selectDatas.innerHTML = '<option value="">Selecione</option>';
        datas.forEach(data => {
          const opt = document.createElement("option");
          opt.value = data;
          opt.textContent = data;
          selectDatas.appendChild(opt);
        });
      });

      selectDatas.onchange = () => {
        const data = selectDatas.value;
        if (!data) return;
        mostrarRastro(data);
      };
    }

    function mostrarRastro(data) {
      firebase.database().ref(`/localizacoes/${data}/${uid}`).once("value", (snap) => {
        const pontos = [];
        heatMap = {}; // reset para o dia escolhido

        // ordenar por timestamp
        const arr = [];
        snap.forEach(child => arr.push({ key: child.key, val: child.val() }));
        arr.sort((a,b) => Number(a.key) - Number(b.key));

        arr.forEach(({val}) => {
          const { latitude, longitude } = val || {};
          if (typeof latitude === "number" && typeof longitude === "number") {
            const key = `${latitude.toFixed(5)},${longitude.toFixed(5)}`;
            heatMap[key] = (heatMap[key] || 0) + 1;
            pontos.push([latitude, longitude]);
          }
        });

        desenharLinhas(pontos);
        if (pontos.length) {
          const bounds = L.latLngBounds(pontos);
          map.fitBounds(bounds, { padding: [30,30] });
        }
      });
    }

    /* ==========================
       LIMPAR DADOS ANTIGOS (>24h)
       ========================== */
    function limparDadosAntigos() {
      const agora = Date.now();
      firebase.database().ref("/localizacoes").once("value", (snapshot) => {
        snapshot.forEach((dataSnap) => {
          dataSnap.forEach((userSnap) => {
            userSnap.forEach((pontoSnap) => {
              const timestamp = Number(pontoSnap.key);
              if (!isNaN(timestamp) && (agora - timestamp > 86400000)) {
                pontoSnap.ref.remove();
              }
            });
          });
        });
      });
    }

    /* ==========================
       SEED DE HISTÓRICO (30 DIAS)
       ========================== */
    async function seedHistoricoIfEmpty() {
      const db = firebase.database();

      // verifica se já existe algum dia no último mês
      const start = new Date();
      start.setDate(start.getDate() - 30);
      const end = new Date();
      end.setDate(end.getDate() - 1); // até ontem

      const checkSnap = await db.ref("/localizacoes").once("value");
      const temAlgum = !!checkSnap.val();
      if (temAlgum) return; // já tem histórico, não sobrescreve

      // Rotas simuladas (pequenas variações ao redor do ponto base)
      function jitter(val, metros=60) {
        const deg = metros / 111320; // ~1 deg ~ 111.32 km
        return val + (Math.random() - 0.5) * deg;
      }

      function caminhoManha() {
        // Base → “escola” → praça → volta
        return [
          [jitter(BASE_LAT, 0), jitter(BASE_LNG, 0)],
          [jitter(BASE_LAT+0.0008), jitter(BASE_LNG-0.0006)],
          [jitter(BASE_LAT+0.0012), jitter(BASE_LNG-0.0009)],
          [jitter(BASE_LAT+0.0010), jitter(BASE_LNG-0.0002)],
          [jitter(BASE_LAT+0.0003), jitter(BASE_LNG+0.0001)],
          [jitter(BASE_LAT, 0), jitter(BASE_LNG, 0)]
        ];
      }

      function caminhoTarde() {
        // Base → mercadinho → rua paralela → volta
        return [
          [jitter(BASE_LAT, 0), jitter(BASE_LNG, 0)],
          [jitter(BASE_LAT-0.0007), jitter(BASE_LNG+0.0003)],
          [jitter(BASE_LAT-0.0010), jitter(BASE_LNG+0.0008)],
          [jitter(BASE_LAT-0.0004), jitter(BASE_LNG+0.0010)],
          [jitter(BASE_LAT, 0), jitter(BASE_LNG, 0)]
        ];
      }

      // grava pontos no dia (timestamps espaçados)
      async function gravarDia(dataISO, rotas) {
        const baseDate = new Date(dataISO + "T08:00:00");
        let t = baseDate.getTime();
        for (const rota of rotas) {
          for (const [lat,lng] of rota) {
            const path = `/localizacoes/${dataISO}/${uid}/${t}`;
            await db.ref(path).set({ latitude: lat, longitude: lng });
            t += 1000 * 60 * 3; // a cada 3 min
          }
          t += 1000 * 60 * 30; // pausa 30 min entre rotas
        }
      }

      // percorre dias úteis com duas “caminhadas”, fins de semana uma só
      const cursor = new Date(start);
      while (cursor <= end) {
        const iso = cursor.toISOString().slice(0,10);
        if (cursor.getDay() === 0 || cursor.getDay() === 6) {
          // fim de semana: 1 rota
          await gravarDia(iso, [caminhoTarde()]);
        } else {
          // dias úteis: 2 rotas (manhã e tarde)
          await gravarDia(iso, [caminhoManha(), caminhoTarde()]);
        }
        cursor.setDate(cursor.getDate() + 1);
      }
    }
  </script>
</body>
</html>
